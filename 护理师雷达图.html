<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ¤ç†å¸ˆè¡¨ç°é›·è¾¾å›¾</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
          
        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .nurse-tags {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nurse-tag {
            padding: 8px 16px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            background: white;
            color: #495057;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
            user-select: none;
        }

        .nurse-tag:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .nurse-tag.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .nurse-tag.active:hover {
            background: linear-gradient(135deg, #5a72d8 0%, #6b4190 100%);
            transform: translateY(-2px);
        }
        
        .control-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        label {
            font-weight: 500;
            color: #495057;
        }
        
        select {
            padding: 8px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            min-width: 150px;
            transition: border-color 0.3s;
        }
        
        select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .chart-container {
            padding: 30px;
            position: relative;
            height: 700px;
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
        }
        
        .info-panel {
            display: flex;
            justify-content: space-between;
            padding: 0 40px 20px 40px;
            background: #f8f9fa;
        }
        
        .info-card {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            flex: 1;
            margin: 0 10px;
            text-align: center;
        }
        
        .info-card h3 {
            margin: 0 0 10px 0;
            color: #667eea;
            font-size: 16px;
        }
        
        .info-card p {
            margin: 0;
            color: #6c757d;
            font-size: 14px;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }
        
        .toggle-labels-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .toggle-labels-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .toggle-labels-btn:active {
            transform: translateY(0);
        }

        .toggle-labels-btn.hidden {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            box-shadow: 0 2px 8px rgba(108, 117, 125, 0.2);
        }

        .toggle-labels-btn.hidden:hover {
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

        .score-summary {
            padding: 15px 25px;
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin: 15px 40px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.03);
        }

        .score-summary h2 {
            margin: 0 0 12px 0;
            font-size: 16px;
            color: #2c3e50;
            font-weight: 600;
            text-align: center;
        }

        .score-summary-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }

        .rank-card {
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            transition: all 0.2s ease;
            text-align: center;
            min-width: 110px;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .rank-card:hover {
            background: #f1f3f4;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(102, 126, 234, 0.15);
        }

        .dimension-name {
            font-weight: 700;
            font-size: 14px;
            color: #2c3e50;
            margin-bottom: 8px;
            white-space: nowrap;
        }

        .rank-info {
            font-size: 12px;
            line-height: 1.3;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .rank-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            flex: 1;
        }

        .rank-label {
            font-size: 10px;
            color: #6c757d;
            font-weight: 500;
        }

        .rank-value {
            font-weight: 700;
            font-size: 13px;
        }

        .rank-first .rank-value { color: #dc3545; font-weight: 700; }
        .rank-normal .rank-value { color: #2c3e50; font-weight: 600; }

        /* è½¬åŒ–ç‡ç‰¹æ®Šæ ·å¼ */
        .score-summary-content .rank-card:nth-child(1),
        .score-summary-content .rank-card:nth-child(2),
        .score-summary-content .rank-card:nth-child(3) {
            border-left-color: #28a745;
        }

        /* äºŒæ¬¡åˆ°åº—ç‡ç‰¹æ®Šæ ·å¼ */
        .score-summary-content .rank-card:nth-child(4),
        .score-summary-content .rank-card:nth-child(5),
        .score-summary-content .rank-card:nth-child(6),
        .score-summary-content .rank-card:nth-child(7) {
            border-left-color: #fd7e14;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <div class="nurse-tags" id="nurseTags">
                <!-- æŠ¤ç†å¸ˆæ ‡ç­¾å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <div class="score-summary" id="scoreSummary" style="display: none;">
            <h2 id="overallScore">å¹³å‡è¡¨ç°ï¼š0%</h2>
            <p id="scoreDescription">è¯·é€‰æ‹©æŠ¤ç†å¸ˆæŸ¥çœ‹è¯¦ç»†åˆ†æ</p>
        </div>
        
                
        <div class="chart-container">
            <button class="toggle-labels-btn" id="toggleLabelsBtn" onclick="toggleDataLabels()">
                <span id="btnIcon">ğŸ‘ï¸</span>
                <span id="btnText">éšè—æ•°å­—</span>
            </button>
            <button class="toggle-labels-btn" id="toggleDetailBtn" onclick="toggleDetailLabels()" style="top: 45px;">
                <span id="detailBtnIcon">ğŸ“Š</span>
                <span id="detailBtnText">æ˜¾ç¤ºè¯¦æƒ…</span>
            </button>
            <canvas id="radarChart"></canvas>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: rgba(255, 193, 7, 0.3); border: 3px solid rgb(255, 193, 7);"></div>
                <span>å®é™…è¡¨ç°</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: rgb(220, 53, 69); border: 2px solid #fff; border-radius: 50%;"></div>
                <span>åŠæ ¼æ ‡å‡†ç‚¹</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: rgb(13, 110, 253); border: 2px solid #fff; border-radius: 50%;"></div>
                <span>ä¼˜ç§€æ ‡å‡†ç‚¹</span>
            </div>
        </div>
    </div>

    <script>
        // åŸå§‹æ•°æ®
        const rawData = `é—¨åº—,æŠ¤ç†å¸ˆ,å¹´ä»½,æœˆä»½,Aç±»è½¬åŒ–ç‡,Bç±»è½¬åŒ–ç‡,Cç±»è½¬åŒ–ç‡,Dç±»è½¬åŒ–ç‡,Aç±»äºŒæ¬¡åˆ°åº—ç‡,Bç±»äºŒæ¬¡åˆ°åº—ç‡,Cç±»äºŒæ¬¡åˆ°åº—ç‡,Dç±»äºŒæ¬¡åˆ°åº—ç‡
å¹³å®‰,Fancy,2025,10,25,20,40,0,15,50,50,43.33
å¹³å®‰,Iris,2025,10,0,20,50,5,0,20,75,60
å¹³å®‰,Merry,2025,10,15,20,30,0,30,40,55,70
å¹³å®‰,Miya,2025,10,5,40,55,0,25,60,60,56.67
å¹³å®‰,Tammy,2025,10,10,10,35,0,10,60,50,33.33
ä¾¨åŸ,Ava,2025,10,15,60,20,5,25,60,60,66.67
ä¾¨åŸ,Cary,2025,10,20,0,12.5,0,30,100,50,62.5
ä¾¨åŸ,Emma,2025,10,15,10,45,5,10,40,65,73.33
ä¾¨åŸ,Vivi,2025,10,10,50,50,5,15,77.78,60,80
ä¾¨åŸ,Yuki,2025,10,15,40,40,0,25,70,60,80
åŒçº,Gina,2025,10,40,50,30,5,20,60,60,66.67
åŒçº,Lena,2025,10,15,60,33.33,5,30,75,50,63.33
åŒçº,Lilian,2025,10,20,40,50,5,35,80,60,63.33
åŒçº,Lucy,2025,10,25,40,40,10,50,50,55,63.33`;
        
        // æ ‡å‡†è®¾ç½® - ä¼˜ç§€å€¼ä½œä¸ºåæ ‡è½´é¡¶ç‚¹
        const standards = {
            'Aç±»è½¬åŒ–ç‡': { pass: 20, excellent: 40 }, // 40%ä½œä¸ºé¡¶ç‚¹
            'Bç±»è½¬åŒ–ç‡': { pass: 50, excellent: 80 }, // 80%ä½œä¸ºé¡¶ç‚¹
            'Cç±»è½¬åŒ–ç‡': { pass: 50, excellent: 80 }, // 80%ä½œä¸ºé¡¶ç‚¹
            'Aç±»äºŒæ¬¡åˆ°åº—ç‡': { pass: 20, excellent: 40 },
            'Bç±»äºŒæ¬¡åˆ°åº—ç‡': { pass: 60, excellent: 80 }, // 80%ä½œä¸ºé¡¶ç‚¹
            'Cç±»äºŒæ¬¡åˆ°åº—ç‡': { pass: 60, excellent: 80 }, // 80%ä½œä¸ºé¡¶ç‚¹
            'Dç±»äºŒæ¬¡åˆ°åº—ç‡': { pass: 60, excellent: 80 }  // 80%ä½œä¸ºé¡¶ç‚¹
        };
        
        // è§£ææ•°æ®
        function parseData() {
            const lines = rawData.trim().split('\n');
            const headers = lines[0].split(',');
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const record = {};
                headers.forEach((header, index) => {
                    record[header] = values[index];
                });
                data.push(record);
            }
            
            return data;
        }
        
        // æ ‡å‡†åŒ–è®¡ç®—ï¼šä»¥å„ç»´åº¦ä¼˜ç§€å€¼ä¸º100%è¿›è¡Œæ ‡å‡†åŒ–
        function calculateScore(value, dimension) {
            const numValue = parseFloat(value) || 0;
            const standard = standards[dimension];
            
            if (standard.excellent) {
                // ä»¥è¯¥ç»´åº¦çš„ä¼˜ç§€å€¼ä¸ºåŸºå‡†æ ‡å‡†åŒ–åˆ°100
                return (numValue / standard.excellent) * 100;
            }
            return numValue;
        }
        
        // è·å–åŠæ ¼çº¿æ ‡å‡†åŒ–æ•°å€¼
        function getPassLine(dimension) {
            const standard = standards[dimension];
            if (standard.pass !== null && standard.excellent) {
                // æŒ‰ä¼˜ç§€å€¼æ ‡å‡†åŒ–åŠæ ¼çº¿
                return (standard.pass / standard.excellent) * 100;
            }
            return null;
        }
        
        // è®¡ç®—åŠ¨æ€çš„åæ ‡è½´æœ€å¤§å€¼
        function calculateAxisMax(actualScores, dimensions) {
            // æ ‡å‡†åŒ–åï¼Œä¼˜ç§€å€¼éƒ½æ˜¯100%
            const excellentStandard = 100;
            
            // æ‰¾åˆ°å®é™…æ ‡å‡†åŒ–æ•°æ®ä¸­çš„æœ€å¤§å€¼
            const maxActual = Math.max(...actualScores.filter(score => score !== null && score !== undefined));
            
            // å¦‚æœå®é™…å€¼è¶…è¿‡100%ï¼ˆä¼˜ç§€æ ‡å‡†ï¼‰ï¼Œåˆ™æ‰©å±•åæ ‡è½´
            if (maxActual > excellentStandard) {
                return Math.ceil(maxActual * 1.1 / 10) * 10; // å‘ä¸Šå–æ•´åˆ°10çš„å€æ•°
            } else {
                return 100; // ä¼˜ç§€å€¼å°±æ˜¯è¾¹ç¼˜ï¼Œä¸éœ€è¦é¢å¤–ç©ºé—´
            }
        }
        
        // è®¡ç®—æ’åç³»ç»Ÿï¼ˆæ”¯æŒå¯†é›†å¹¶åˆ—æ’åï¼‰
        function calculateRankings(selectedNurse, dimensions) {
            const rankings = {};

            dimensions.forEach(dimension => {
                // è·å–æ‰€æœ‰æŠ¤ç†å¸ˆåœ¨è¯¥ç»´åº¦çš„æ•°æ®
                const allScores = parsedData.map(nurse => ({
                    name: nurse['æŠ¤ç†å¸ˆ'],
                    store: nurse['é—¨åº—'],
                    score: parseFloat(nurse[dimension]) || 0
                }));

                // æŒ‰åˆ†æ•°é™åºæ’åº
                allScores.sort((a, b) => b.score - a.score);

                // è®¡ç®—å…¨å…¬å¸æ’åï¼ˆå¯†é›†å¹¶åˆ—æ’åï¼‰
                let companyRank = null;
                let currentRank = 1;
                for (let i = 0; i < allScores.length; i++) {
                    if (i > 0 && allScores[i].score < allScores[i-1].score) {
                        currentRank++; // å¯†é›†æ’åï¼šæ¯æ¬¡åªé€’å¢1
                    }
                    if (allScores[i].name === selectedNurse) {
                        companyRank = currentRank;
                        break;
                    }
                }

                // è®¡ç®—å…¨åº—æ’åï¼ˆå¯†é›†å¹¶åˆ—æ’åï¼‰
                const selectedNurseStore = parsedData.find(nurse => nurse['æŠ¤ç†å¸ˆ'] === selectedNurse)['é—¨åº—'];
                const storeScores = allScores.filter(nurse => nurse.store === selectedNurseStore);
                let storeRank = null;
                currentRank = 1;
                for (let i = 0; i < storeScores.length; i++) {
                    if (i > 0 && storeScores[i].score < storeScores[i-1].score) {
                        currentRank++; // å¯†é›†æ’åï¼šæ¯æ¬¡åªé€’å¢1
                    }
                    if (storeScores[i].name === selectedNurse) {
                        storeRank = currentRank;
                        break;
                    }
                }

                rankings[dimension] = {
                    companyRank: companyRank,
                    storeRank: storeRank,
                    totalCompany: allScores.length,
                    totalStore: storeScores.length
                };
            });
            
            return rankings;
        }
        
        let chart = null;
        let parsedData = [];
        let isPluginRegistered = false;
        let showDataLabels = true; // é»˜è®¤æ˜¾ç¤ºæ•°æ®æ ‡ç­¾
        let showDetailLabels = false; // é»˜è®¤ä¸æ˜¾ç¤ºè¯¦ç»†æ’åä¿¡æ¯
        let currentNurse = null; // å½“å‰é€‰æ‹©çš„æŠ¤ç†å¸ˆ
        
        // åˆå§‹åŒ–
        function init() {
            try {
                console.log('å¼€å§‹åˆå§‹åŒ–...');
                parsedData = parseData();
                console.log('æ•°æ®è§£æå®Œæˆï¼Œå…±', parsedData.length, 'æ¡è®°å½•');
                populateNurseTags();
                console.log('åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('åˆå§‹åŒ–é”™è¯¯:', error);
                alert('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°');
            }
        }

        // æ›´æ–°æŠ¤ç†å¸ˆæ ‡ç­¾
        function updateNurseTags() {
            const nurseTagsContainer = document.getElementById('nurseTags');

            // æ¸…ç©ºç°æœ‰æ ‡ç­¾
            nurseTagsContainer.innerHTML = '';

            // æ˜¾ç¤ºæ‰€æœ‰æŠ¤ç†å¸ˆ
            const nurses = [...new Set(parsedData.map(item => item['æŠ¤ç†å¸ˆ']))];
            nurses.forEach((nurse, index) => {
                const tag = document.createElement('div');
                tag.className = 'nurse-tag';
                tag.textContent = nurse;
                tag.onclick = () => selectNurse(nurse, tag);
                nurseTagsContainer.appendChild(tag);

                // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæŠ¤ç†å¸ˆ
                if (index === 0) {
                    setTimeout(() => {
                        selectNurse(nurse, tag);
                    }, 100);
                }
            });
        }

        // é€‰æ‹©æŠ¤ç†å¸ˆ
        function selectNurse(nurseName, tagElement) {
            // ç§»é™¤æ‰€æœ‰activeç±»
            document.querySelectorAll('.nurse-tag').forEach(tag => {
                tag.classList.remove('active');
            });

            // æ·»åŠ activeç±»åˆ°é€‰ä¸­çš„æ ‡ç­¾
            tagElement.classList.add('active');

            // è®°å½•å½“å‰é€‰æ‹©çš„æŠ¤ç†å¸ˆ
            currentNurse = nurseName;

            // æ›´æ–°å›¾è¡¨
            updateChartWithNurse(nurseName);
        }

        // åˆ‡æ¢æ•°æ®æ ‡ç­¾æ˜¾ç¤º
        function toggleDataLabels() {
            showDataLabels = !showDataLabels;

            const btn = document.getElementById('toggleLabelsBtn');
            const btnText = document.getElementById('btnText');
            const btnIcon = document.getElementById('btnIcon');

            if (showDataLabels) {
                btn.classList.remove('hidden');
                btnText.textContent = 'éšè—æ•°å­—';
                btnIcon.textContent = 'ğŸ‘ï¸';
            } else {
                btn.classList.add('hidden');
                btnText.textContent = 'æ˜¾ç¤ºæ•°å­—';
                btnIcon.textContent = 'ğŸ‘ï¸â€ğŸ—¨ï¸';
            }

            // æ›´æ–°æ¯ä¸ªæ•°æ®é›†çš„æ ‡ç­¾æ˜¾ç¤º
            if (chart) {
                chart.data.datasets.forEach(dataset => {
                    dataset.datalabels.display = showDataLabels;
                });
                chart.update();
            }
        }

        // åˆ‡æ¢è¯¦ç»†æ’åä¿¡æ¯æ˜¾ç¤º
        function toggleDetailLabels() {
            showDetailLabels = !showDetailLabels;

            const btn = document.getElementById('toggleDetailBtn');
            const btnText = document.getElementById('detailBtnText');
            const btnIcon = document.getElementById('detailBtnIcon');

            if (showDetailLabels) {
                btn.classList.remove('hidden');
                btnText.textContent = 'éšè—è¯¦æƒ…';
                btnIcon.textContent = 'ğŸ“Š';
            } else {
                btn.classList.add('hidden');
                btnText.textContent = 'æ˜¾ç¤ºè¯¦æƒ…';
                btnIcon.textContent = 'ğŸ“ˆ';
            }

            // é‡æ–°åˆ›å»ºå›¾è¡¨ä»¥æ›´æ–°æ ‡ç­¾å†…å®¹
            if (chart && currentNurse) {
                updateChartWithNurse(currentNurse);
            }
        }

        // å¡«å……æŠ¤ç†å¸ˆæ ‡ç­¾ï¼ˆåˆå§‹åŒ–æ—¶ä½¿ç”¨ï¼‰
        function populateNurseTags() {
            updateNurseTags();
        }
        
        // æ›´æ–°å›¾è¡¨ï¼ˆæ¥å—æŠ¤ç†å¸ˆåç§°å‚æ•°ï¼‰
        function updateChartWithNurse(selectedNurse) {
            try {
                console.log('å¼€å§‹æ›´æ–°å›¾è¡¨...', selectedNurse);

                if (!selectedNurse) {
                    document.getElementById('scoreSummary').style.display = 'none';
                    if (chart) {
                        chart.destroy();
                        chart = null;
                    }
                    return;
                }

                // æ‰¾åˆ°é€‰ä¸­æŠ¤ç†å¸ˆçš„æ•°æ®
                const nurseData = parsedData.find(item => item['æŠ¤ç†å¸ˆ'] === selectedNurse);
                console.log('æ‰¾åˆ°æŠ¤ç†å¸ˆæ•°æ®:', nurseData);

                if (!nurseData) {
                    console.error('æœªæ‰¾åˆ°æŠ¤ç†å¸ˆæ•°æ®:', selectedNurse);
                    return;
                }
            
            // å‡†å¤‡é›·è¾¾å›¾æ•°æ® - ç§»é™¤Dç±»è½¬åŒ–ç‡
            const dimensions = [
                'Aç±»è½¬åŒ–ç‡', 'Bç±»è½¬åŒ–ç‡', 'Cç±»è½¬åŒ–ç‡',
                'Aç±»äºŒæ¬¡åˆ°åº—ç‡', 'Bç±»äºŒæ¬¡åˆ°åº—ç‡', 'Cç±»äºŒæ¬¡åˆ°åº—ç‡', 'Dç±»äºŒæ¬¡åˆ°åº—ç‡'
            ];
            
            const actualScores = dimensions.map(dim => 
                calculateScore(nurseData[dim], dim)
            );
            
            const passScores = dimensions.map(dim => 
                getPassLine(dim)
            );
            
            // è®¡ç®—ç»¼åˆå¾—åˆ†ï¼ˆä½¿ç”¨åŸå§‹æ•°æ®ï¼‰
            const originalScores = dimensions.map(dim => parseFloat(nurseData[dim]) || 0);
            const overallScore = originalScores.reduce((sum, score) => sum + score, 0) / dimensions.length;
            
            // è®¡ç®—æ’åä¿¡æ¯
            const rankings = calculateRankings(selectedNurse, dimensions);
            
            // æ›´æ–°å¾—åˆ†æ‘˜è¦
            updateScoreSummary(selectedNurse, nurseData['é—¨åº—'], overallScore, originalScores, dimensions, rankings);
            
            // è®¡ç®—åŠ¨æ€åæ ‡è½´æœ€å¤§å€¼
            const axisMax = calculateAxisMax(actualScores, dimensions);
            
            // è·å–åŸå§‹æ•°æ®ç”¨äºæ ‡ç­¾æ˜¾ç¤º
            const originalData = dimensions.map(dim => parseFloat(nurseData[dim]) || 0);
            
                // åˆ›å»ºå›¾è¡¨
                console.log('å¼€å§‹åˆ›å»ºé›·è¾¾å›¾...');
                createRadarChart(dimensions, actualScores, passScores, selectedNurse, axisMax, originalData, rankings);
                console.log('å›¾è¡¨åˆ›å»ºå®Œæˆ');
            } catch (error) {
                console.error('æ›´æ–°å›¾è¡¨é”™è¯¯:', error);
                alert('å›¾è¡¨æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°: ' + error.message);
            }
        }
        
        // æ›´æ–°å¾—åˆ†æ‘˜è¦
        function updateScoreSummary(nurseName, store, overallScore, scores, dimensions, rankings) {
            document.getElementById('scoreSummary').style.display = 'block';
            document.getElementById('overallScore').textContent = '';

            let description = '<div class="score-summary-content">';

            dimensions.forEach((dimension, index) => {
                const rank = rankings[dimension];
                let shortName;
                if (dimension.includes('è½¬åŒ–ç‡')) {
                    shortName = dimension.replace('Aç±»', 'A').replace('Bç±»', 'B').replace('Cç±»', 'C');
                } else {
                    shortName = dimension.replace('Aç±»', 'A').replace('Bç±»', 'B').replace('Cç±»', 'C').replace('Dç±»', 'D')
                                     .replace('äºŒæ¬¡åˆ°åº—ç‡', 'äºŒæ¬¡');
                }

                // ç¡®å®šæ’åç­‰çº§
                let storeRankClass = rank.storeRank === 1 ? 'rank-first' : 'rank-normal';
                let companyRankClass = rank.companyRank === 1 ? 'rank-first' : 'rank-normal';

                description += `
                    <div class="rank-card">
                        <div class="dimension-name">${shortName}</div>
                        <div class="rank-info">
                            <div class="rank-item ${storeRankClass}">
                                <div class="rank-label">å…¨åº—</div>
                                <div class="rank-value">${rank.storeRank}</div>
                            </div>
                            <div class="rank-item ${companyRankClass}">
                                <div class="rank-label">å…¨å…¬å¸</div>
                                <div class="rank-value">${rank.companyRank}</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            description += '</div>';
            document.getElementById('scoreDescription').innerHTML = description;
        }
        
        // åˆ›å»ºé›·è¾¾å›¾
        function createRadarChart(labels, actualData, passData, nurseName, axisMax, originalData, rankings) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }
            
            // è®¡ç®—ä¼˜ç§€å€¼çº¿æ•°æ® - æ ‡å‡†åŒ–åéƒ½æ˜¯100%
            const excellentData = labels.map(label => {
                const standard = standards[label];
                // å¦‚æœè®¾ç½®äº†ä¼˜ç§€å€¼ï¼Œåˆ™æ˜¾ç¤ºä¸ºæ ‡å‡†åŒ–çš„100%
                return standard.excellent !== null ? 100 : null;
            });
            
            // æ³¨å†ŒDataLabelsæ’ä»¶
            if (!isPluginRegistered) {
                Chart.register(ChartDataLabels);
                isPluginRegistered = true;
            }
            
            chart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${nurseName} å®é™…è¡¨ç°`,
                        data: actualData,
                        backgroundColor: 'rgba(255, 193, 7, 0.3)',
                        borderColor: 'rgb(255, 193, 7)',
                        borderWidth: 3,
                        pointBackgroundColor: 'rgb(255, 193, 7)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 8,
                        fill: true,
                        datalabels: {
                            display: showDataLabels,
                            color: 'rgb(255, 140, 0)',
                            font: { weight: 'bold', size: 8 },
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            borderColor: 'rgb(255, 193, 7)',
                            borderWidth: 1,
                            borderRadius: 3,
                            padding: 2,
                            textAlign: 'center',
                            formatter: function(value, context) {
                                // æ ¹æ®showDetailLabelså˜é‡æ˜¾ç¤ºä¸åŒè¯¦ç»†ç¨‹åº¦çš„ä¿¡æ¯
                                const originalValue = originalData[context.dataIndex];
                                const dimension = context.chart.data.labels[context.dataIndex];
                                const rank = rankings[dimension];

                                let displayText = originalValue.toFixed(1) + '%';

                                if (showDetailLabels && rank) {
                                    // æ˜¾ç¤ºè¯¦ç»†æ’åä¿¡æ¯
                                    displayText += '\nå…¨åº—ç¬¬' + rank.storeRank + 'å';
                                    displayText += '\nå…¨å…¬å¸ç¬¬' + rank.companyRank + 'å';
                                }
                                // é»˜è®¤ä¸æ˜¾ç¤ºä»»ä½•æ’åä¿¡æ¯ï¼Œä¿æŒç®€æ´

                                return displayText;
                            },
                            // æ™ºèƒ½è°ƒæ•´æ ‡ç­¾ä½ç½®ï¼Œé¿å…0å€¼é‡å 
                            anchor: function(context) {
                                const dataIndex = context.dataIndex;
                                const originalValue = originalData[context.dataIndex];

                                // æ£€æŸ¥æ˜¯å¦ä¸º0å€¼æˆ–æ¥è¿‘0å€¼ï¼Œé˜²æ­¢æ ‡ç­¾é‡å 
                                if (originalValue <= 1) {
                                    // å¯¹äº0å€¼ï¼Œåˆ†æ•£åˆ°ä¸åŒä½ç½®é¿å…é‡å 
                                    const zeroValuePositions = ['end', 'start', 'center', 'end', 'start', 'center', 'end'];
                                    return zeroValuePositions[dataIndex];
                                }

                                // æ­£å¸¸å€¼çš„å¤–ç§»é€»è¾‘
                                if (dataIndex === 0) return 'end';      // Aç±»è½¬åŒ–ç‡
                                if (dataIndex === 1) return 'end';      // Bç±»è½¬åŒ–ç‡
                                if (dataIndex === 2) return 'end';      // Cç±»è½¬åŒ–ç‡
                                if (dataIndex === 3) return 'end';      // Aç±»äºŒæ¬¡åˆ°åº—ç‡
                                if (dataIndex === 4) return 'end';      // Bç±»äºŒæ¬¡åˆ°åº—ç‡
                                if (dataIndex === 5) return 'end';      // Cç±»äºŒæ¬¡åˆ°åº—ç‡
                                if (dataIndex === 6) return 'end';      // Dç±»äºŒæ¬¡åˆ°åº—ç‡
                                return 'end';
                            },
                            align: function(context) {
                                const dataIndex = context.dataIndex;
                                const originalValue = originalData[context.dataIndex];

                                // å¯¹äº0å€¼ï¼Œä½¿ç”¨ä¸åŒçš„å¯¹é½æ–¹å¼è¿›ä¸€æ­¥åˆ†ç¦»
                                if (originalValue <= 1) {
                                    const zeroValueAligns = ['bottom', 'top', 'middle', 'bottom', 'top', 'middle', 'bottom'];
                                    return zeroValueAligns[dataIndex];
                                }

                                // æ­£å¸¸å€¼çš„å¯¹é½æ–¹å¼
                                if (dataIndex === 0) return 'bottom';   // Aç±»è½¬åŒ–ç‡
                                if (dataIndex === 1) return 'bottom';   // Bç±»è½¬åŒ–ç‡
                                if (dataIndex === 2) return 'bottom';   // Cç±»è½¬åŒ–ç‡
                                if (dataIndex === 3) return 'bottom';   // Aç±»äºŒæ¬¡åˆ°åº—ç‡
                                if (dataIndex === 4) return 'top';      // Bç±»äºŒæ¬¡åˆ°åº—ç‡
                                if (dataIndex === 5) return 'top';      // Cç±»äºŒæ¬¡åˆ°åº—ç‡
                                if (dataIndex === 6) return 'bottom';   // Dç±»äºŒæ¬¡åˆ°åº—ç‡
                                return 'bottom';
                            },
                            offset: function(context) {
                                const dataIndex = context.dataIndex;
                                const originalValue = originalData[context.dataIndex];

                                // å¯¹äº0å€¼ï¼Œä½¿ç”¨æ›´å¤§çš„åç§»é‡ç¡®ä¿åˆ†ç¦»
                                if (originalValue <= 1) {
                                    const zeroValueOffsets = [35, 30, 25, 35, 30, 25, 35];
                                    return zeroValueOffsets[dataIndex];
                                }

                                // æ­£å¸¸å€¼çš„åç§»é‡
                                if (dataIndex === 0) return 25;   // Aç±»è½¬åŒ–ç‡
                                if (dataIndex === 1) return 20;   // Bç±»è½¬åŒ–ç‡
                                if (dataIndex === 2) return 20;   // Cç±»è½¬åŒ–ç‡
                                if (dataIndex === 3) return 22;   // Aç±»äºŒæ¬¡åˆ°åº—ç‡
                                if (dataIndex === 4) return 18;   // Bç±»äºŒæ¬¡åˆ°åº—ç‡
                                if (dataIndex === 5) return 18;   // Cç±»äºŒæ¬¡åˆ°åº—ç‡
                                if (dataIndex === 6) return 25;   // Dç±»äºŒæ¬¡åˆ°åº—ç‡
                                return 20;
                            }
                        }
                    }, {
                        label: 'åŠæ ¼æ ‡å‡†çº¿',
                        data: passData,
                        backgroundColor: 'transparent',
                        borderColor: 'transparent',
                        borderWidth: 0,
                        pointBackgroundColor: 'rgb(220, 53, 69)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 8,
                        fill: false,
                        showLine: false,
                        datalabels: {
                            display: showDataLabels,
                            color: 'rgb(220, 53, 69)',
                            font: { weight: 'bold', size: 8 },
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            borderColor: 'rgb(220, 53, 69)',
                            borderWidth: 1,
                            borderRadius: 2,
                            padding: 1,
                            formatter: function(value, context) {
                                const dimension = context.chart.data.labels[context.dataIndex];
                                const standard = standards[dimension];
                                return standard.pass !== null ? standard.pass + '%' : '';
                            },
                            // åŠæ ¼æ ‡å‡†ç‚¹æ¢å¤åˆ°æ­£å¸¸ä½ç½®ï¼Œå› ä¸ºå®é™…æ ‡ç­¾å·²å¤–ç§»
                            anchor: function(context) {
                                const dataIndex = context.dataIndex;
                                // æ¢å¤åŸæ¥çš„å¸ƒå±€ï¼Œçº¢ç‚¹æ˜¾ç¤ºåœ¨ä¸­å¿ƒé™„è¿‘
                                return dataIndex <= 3 ? 'end' : 'start';
                            },
                            align: function(context) {
                                const dataIndex = context.dataIndex;
                                return dataIndex <= 3 ? 'bottom' : 'top';
                            },
                            offset: 5
                        }
                    }, {
                        label: 'ä¼˜ç§€æ ‡å‡†çº¿',
                        data: excellentData,
                        backgroundColor: 'transparent',
                        borderColor: 'transparent',
                        borderWidth: 0,
                        pointBackgroundColor: 'rgb(13, 110, 253)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 8,
                        fill: false,
                        showLine: false,
                        datalabels: {
                            display: showDataLabels,
                            color: 'rgb(13, 110, 253)',
                            font: { weight: 'bold', size: 8 },
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            borderColor: 'rgb(13, 110, 253)',
                            borderWidth: 1,
                            borderRadius: 2,
                            padding: 1,
                            formatter: function(value, context) {
                                const dimension = context.chart.data.labels[context.dataIndex];
                                const standard = standards[dimension];
                                return standard.excellent !== null ? standard.excellent + '%' : '';
                            },
                            // æ ¹æ®ç»´åº¦ä½ç½®åŠ¨æ€è°ƒæ•´æ ‡ç­¾ä½ç½®ï¼Œé¿å…ä¸å®é™…æ•°æ®æ ‡ç­¾é‡å 
                            anchor: function(context) {
                                const dataIndex = context.dataIndex;
                                // é’ˆå¯¹Aç±»è½¬åŒ–ç‡(0)å’ŒDç±»äºŒæ¬¡åˆ°åº—ç‡(6)ç‰¹æ®Šå¤„ç†ï¼Œé¿å…é‡å 
                                if (dataIndex === 0) return 'end';    // Aç±»è½¬åŒ–ç‡ - å‘å³æ˜¾ç¤º
                                if (dataIndex === 1) return 'end';    // Bç±»è½¬åŒ–ç‡
                                if (dataIndex === 2) return 'end';    // Cç±»è½¬åŒ–ç‡
                                if (dataIndex === 3) return 'end';    // Aç±»äºŒæ¬¡åˆ°åº—ç‡
                                if (dataIndex === 4) return 'start';  // Bç±»äºŒæ¬¡åˆ°åº—ç‡
                                if (dataIndex === 5) return 'start';  // Cç±»äºŒæ¬¡åˆ°åº—ç‡
                                if (dataIndex === 6) return 'end';    // Dç±»äºŒæ¬¡åˆ°åº—ç‡ - å‘å³æ˜¾ç¤º
                                return 'end';
                            },
                            align: function(context) {
                                const dataIndex = context.dataIndex;
                                if (dataIndex === 0) return 'bottom';  // Aç±»è½¬åŒ–ç‡ - å‘ä¸‹å¯¹é½
                                if (dataIndex === 1) return 'bottom';  // Bç±»è½¬åŒ–ç‡
                                if (dataIndex === 2) return 'bottom';  // Cç±»è½¬åŒ–ç‡
                                if (dataIndex === 3) return 'bottom';  // Aç±»äºŒæ¬¡åˆ°åº—ç‡
                                if (dataIndex === 4) return 'top';     // Bç±»äºŒæ¬¡åˆ°åº—ç‡
                                if (dataIndex === 5) return 'top';     // Cç±»äºŒæ¬¡åˆ°åº—ç‡
                                if (dataIndex === 6) return 'bottom';  // Dç±»äºŒæ¬¡åˆ°åº—ç‡ - å‘ä¸‹å¯¹é½
                                return 'bottom';
                            },
                            offset: function(context) {
                                const dataIndex = context.dataIndex;
                                // è°ƒæ•´åç§»é‡ç¡®ä¿ä¸é‡å 
                                if (dataIndex === 0) return 10;  // Aç±»è½¬åŒ–ç‡ - é€‚ä¸­åç§»
                                if (dataIndex === 6) return 10;  // Dç±»äºŒæ¬¡åˆ°åº—ç‡ - é€‚ä¸­åç§»
                                return 8;  // å…¶ä»–ç»´åº¦ä¿æŒé€‚ä¸­åç§»
                            }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        datalabels: {
                            display: showDataLabels
                        },
                        legend: {
                            display: false // ä½¿ç”¨è‡ªå®šä¹‰å›¾ä¾‹
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'point',
                            intersect: true,
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    const datasetLabel = context.dataset.label;
                                    const dimension = context.label;
                                    const datasetIndex = context.datasetIndex;

                                    // æ ¹æ®æ•°æ®é›†ç±»å‹æ˜¾ç¤ºæ­£ç¡®çš„æ•°å€¼
                                    if (datasetIndex === 0) {
                                        // å®é™…è¡¨ç°æ•°æ®é›† - æ˜¾ç¤ºåŸå§‹æ•°æ®
                                        const originalValue = originalData[context.dataIndex];
                                        return `${datasetLabel}: ${originalValue.toFixed(1)}%`;
                                    } else if (datasetIndex === 1) {
                                        // åŠæ ¼æ ‡å‡†çº¿ - æ˜¾ç¤ºçœŸå®åŠæ ¼å€¼
                                        const passValue = standards[dimension].pass;
                                        return `${datasetLabel}: ${passValue}%`;
                                    } else if (datasetIndex === 2) {
                                        // ä¼˜ç§€æ ‡å‡†çº¿ - æ˜¾ç¤ºçœŸå®ä¼˜ç§€å€¼
                                        const excellentValue = standards[dimension].excellent;
                                        return `${datasetLabel}: ${excellentValue}%`;
                                    }

                                    return `${datasetLabel}: ${context.parsed.r.toFixed(1)}%`;
                                },
                                afterLabel: function(context) {
                                    const dimension = context.label;
                                    const datasetIndex = context.datasetIndex;
                                    let result = [];

                                    // åªå¯¹å®é™…è¡¨ç°æ•°æ®é›†(ç´¢å¼•0)æ˜¾ç¤ºæ’å
                                    if (datasetIndex === 0 && rankings[dimension]) {
                                        const rank = rankings[dimension];
                                        result.push(`å…¨åº—ç¬¬${rank.storeRank}å(å…±${rank.totalStore}äºº)`);
                                        result.push(`å…¨å…¬å¸ç¬¬${rank.companyRank}å(å…±${rank.totalCompany}äºº)`);
                                    }
                                    return result;
                                }
                            }
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: axisMax,
                            min: 0,
                            ticks: {
                                display: false // å®Œå…¨éšè—æ‰€æœ‰åˆ»åº¦æ˜¾ç¤º
                            },
                            pointLabels: {
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                },
                                callback: function(label, index) {
                                    // åªæ˜¾ç¤ºç»´åº¦åç§°ï¼Œä¸æ˜¾ç¤ºé¡¶ç‚¹å€¼
                                    return label;
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            angleLines: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    }
                }
            });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>
