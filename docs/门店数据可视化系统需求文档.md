# 门店数据可视化系统需求文档

## 项目概述
基于门店运营数据（2024年6月至2025年10月）开发的数据可视化分析系统，涵盖3家门店（平安、侨城、双玺）的多维度业务指标监控与分析。

## 数据源
- **文件**: `门店数据汇总 - 门店数据2024.6-2025.10.csv`
- **时间范围**: 2024年6月至2025年10月
- **门店数量**: 3家（平安、侨城、双玺）
- **数据指标**: 29项业务指标
- **数据结构**: 按门店、年份、月份组织的数据表

## 核心功能需求

### 1. 基础指标可视化
开发以下基础指标的走势分析图表：

#### 1.1 营收类指标
- **总营收**: 各门店月度总营收变化趋势
- **确认收入**: 各门店月度确认收入变化趋势

#### 1.2 客流类指标
- **总客流**: 各门店月度总客流量变化
- **老客**: 各门店月度老客数量变化

#### 1.3 转化率指标（A/B/C/D类）
- **A类转化率**: A类客户转化效果分析
- **B类转化率**: B类客户转化效果分析
- **C类转化率**: C类客户转化效果分析
- **D类转化率**: D类客户转化效果分析

#### 1.4 服务效率指标
- **总有效服务时长**: 各门店服务时间总投入
- **人均服务时长**: 单客服务效率分析

#### 1.5 获客渠道指标
- **打鱼邀约**: 主动邀约获客效果
- **主动上门**: 自然到店客户数量

### 2. 组合分析图表

#### 2.1 老客分析（原"客户类型分析"）
- **图表标题**: 老客分析
- **数据内容**:
  - 老客总数趋势
  - B类、C类、D类客户数量趋势
  - 各类客户平均数量参考线
- **显示要求**:
  - 每月数据标签显示（每3个数据点显示一次）
  - 图例隐藏，与基础指标保持一致
  - 悬浮提示过滤参考线数据
  - 数值格式化，避免小数点问题

#### 2.2 新客分析（原"新客来源分析"）
- **图表标题**: 新客分析
- **数据内容**:
  - A类客户总数趋势
  - A类美团点评、A类路过、A类老带新、A类其他来源趋势
  - 各来源平均数量参考线
- **显示要求**:
  - 每月数据标签显示（每3个数据点显示一次）
  - 图例隐藏，与基础指标保持一致
  - 悬浮提示过滤参考线数据
  - 数值格式化，避免小数点问题

## 技术实现标准

### 1. 图表配置规范
所有图表必须遵循统一的技术标准：

#### 1.1 图例设置
```javascript
legend: {
    display: false, // 隐藏图例，与基础指标保持一致
}
```

#### 1.2 数据标签显示
```javascript
datalabels: {
    display: function(context) {
        return context.dataIndex % 3 === 0; // 每3个数据点显示一次
    },
}
```

#### 1.3 悬浮提示过滤
```javascript
tooltip: {
    filter: function(tooltipItem) {
        return tooltipItem.datasetIndex < indicators.length; // 过滤参考线
    },
    callbacks: {
        label: function(context) {
            return formatValue(context.parsed.y); // 统一数值格式化
        }
    }
}
```

### 2. 参考线实现
- 为每个指标添加平均数量参考线
- 参考线使用虚线样式，颜色区分
- 参考线不显示在悬浮提示中
- 参考线不显示数据标签

### 3. 数值格式化
- 使用统一的`formatValue()`函数
- 避免过长的小数位显示
- 保持数值的可读性

### 4. 交互体验
- 支持门店筛选功能
- 支持图表导出
- 鼠标悬浮显示详细数据
- 响应式设计，适配不同屏幕

## 用户界面要求

### 1. 导航结构
- 清晰的指标分类导航
- 按照业务逻辑分组显示
- 支持快速跳转到指定图表

### 2. 图表布局
- 每个图表独立显示区域
- 统一的图表尺寸和样式
- 合理的间距和排版

### 3. 数据展示
- 月份数据作为X轴标签
- 数值轴根据指标类型自动调整
- 颜色方案统一且易区分

## 质量要求

### 1. 数据准确性
- 确保图表数据与CSV文件完全一致
- 正确处理数据类型转换
- 准确计算平均值等统计指标

### 2. 性能要求
- 图表加载速度优化
- 数据处理效率高
- 交互响应及时

### 3. 兼容性要求
- 支持主流浏览器
- 移动端友好显示
- 图表库版本稳定（Chart.js 3.9.1）

## 验收标准

### 1. 功能完整性
✅ 所有16个基础指标图表正常显示
✅ 2个组合分析图表功能完整
✅ 门店筛选功能正常
✅ 图表导出功能可用

### 2. 显示准确性
✅ 每月数据标签正确显示（每3个点）
✅ 悬浮提示无重复数据
✅ 数值格式正确，无多余小数位
✅ 参考线正确计算和显示

### 3. 用户体验
✅ 图例统一隐藏
✅ 交互体验流畅
✅ 界面美观整洁
✅ 导航清晰易用

## 开发进度记录

### 第一阶段：基础图表开发
- ✅ 16个基础指标图表实现完成
- ✅ 数据加载和处理逻辑完成
- ✅ 基础交互功能实现

### 第二阶段：组合图表开发
- ✅ 老客分析图表实现
- ✅ 新客分析图表实现
- ✅ 参考线功能集成

### 第三阶段：问题修复优化
- ✅ 图表标题修正（老客分析、新客分析）
- ✅ 数据标签显示修复（每3个月显示）
- ✅ 悬浮提示格式优化
- ✅ 图表配置标准化

## 详细技术实现方案

### 1. 系统架构设计

#### 1.1 文件结构
```
/Users/oscar/Downloads/
├── 门店数据汇总 - 门店数据2024.6-2025.10.csv  # 数据源文件
├── 门店指标走势分析.html                      # 主要可视化页面
└── 门店数据可视化系统需求文档.md               # 本需求文档
```

#### 1.2 技术栈选择
- **前端框架**: HTML5 + JavaScript (ES6+)
- **图表库**: Chart.js 3.9.1 (稳定版本，功能完整)
- **数据标签插件**: chartjs-plugin-datalabels@2.0.0
- **数据处理**: 原生JavaScript CSV解析
- **样式设计**: CSS3 + 响应式布局
- **依赖引入**: CDN方式，确保加载速度

### 2. 核心技术实现

#### 2.1 数据加载与解析模块
```javascript
// 数据存储结构
let storeData = {};
let selectedStore = '平安';

// CSV文件加载
async function loadCSVData() {
    try {
        const response = await fetch('门店数据汇总 - 门店数据2024.6-2025.10.csv');
        const csvText = await response.text();
        const data = parseCSV(csvText);
        storeData = processData(data);
    } catch (error) {
        console.error('数据加载失败:', error);
    }
}

// CSV解析逻辑
function parseCSV(csvText) {
    const lines = csvText.split('\n').filter(line => line.trim());
    const headers = lines[0].split(',');
    const data = [];

    for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',');
        const row = {};
        headers.forEach((header, index) => {
            row[header] = values[index];
        });
        data.push(row);
    }
    return data;
}
```

#### 2.2 数据处理与分组模块
```javascript
// 按门店分组数据
function processData(data) {
    const stores = {};

    data.forEach(row => {
        const storeName = row['门店'];
        if (!stores[storeName]) {
            stores[storeName] = [];
        }

        if (storeName && row['年份'] && row['月份']) {
            stores[storeName].push({
                year: parseInt(row['年份']),
                month: parseInt(row['月份']),
                totalRevenue: parseFloat(row['总营收']) || 0,
                confirmedIncome: parseFloat(row['确认收入']) || 0,
                totalCustomers: parseInt(row['总客流']) || 0,
                oldCustomers: parseInt(row['老客']) || 0,
                // ... 其他29个指标字段
            });
        }
    });

    // 按年月排序
    Object.keys(stores).forEach(store => {
        stores[store].sort((a, b) => {
            if (a.year !== b.year) return a.year - b.year;
            return a.month - b.month;
        });
    });

    return stores;
}
```

#### 2.3 图表创建标准化模板

##### 基础图表模板（以总营收为例）
```javascript
function createBasicChart(canvasId, title, dataKey, borderColor, backgroundColor) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return null;

    const ctx = canvas.getContext('2d');
    const data = storeData[selectedStore];
    const monthlyLabels = data.map(d => `${d.year}年${d.month}月`);

    // 计算平均值用于参考线
    const values = data.map(d => d[dataKey]);
    const avgValue = values.reduce((sum, val) => sum + val, 0) / values.length;

    return new Chart(ctx, {
        type: 'line',
        data: {
            labels: monthlyLabels,
            datasets: [{
                label: title,
                data: values,
                borderColor: borderColor,
                backgroundColor: backgroundColor + '33',
                borderWidth: 2,
                fill: true,
                tension: 0.1,
                pointRadius: 4,
                pointHoverRadius: 6
            }, {
                label: '平均',
                data: Array(values.length).fill(avgValue),
                borderColor: '#ff6384',
                borderWidth: 2,
                borderDash: [5, 5],
                fill: false,
                pointRadius: 0,
                pointHoverRadius: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false // 标准化：隐藏图例
                },
                title: {
                    display: true,
                    text: title,
                    font: {
                        size: 16,
                        weight: 'bold'
                    }
                },
                tooltip: {
                    filter: function(tooltipItem) {
                        return tooltipItem.datasetIndex === 0; // 只显示主线数据，过滤参考线
                    }
                },
                datalabels: {
                    display: function(context) {
                        return context.datasetIndex === 0 && context.dataIndex % 3 === 0; // 每3个点显示标签
                    },
                    color: '#666',
                    font: {
                        weight: 'bold'
                    },
                    formatter: function(value) {
                        return formatValue(value);
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatValue(value);
                        }
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
}
```

##### 组合图表模板（以老客分析为例）
```javascript
function createCustomerTypeChart() {
    const canvas = document.getElementById('customerTypeChart');
    if (!canvas) return null;

    const ctx = canvas.getContext('2d');
    const data = storeData[selectedStore];
    const monthlyLabels = data.map(d => `${d.year}年${d.month}月`);

    // 定义指标配置
    const customerTypeIndicators = [
        { key: 'oldCustomers', label: '老客', color: '#667eea' },
        { key: 'bClassCount', label: 'B类数量', color: '#28a745' },
        { key: 'cClassCount', label: 'C类数量', color: '#ffc107' },
        { key: 'dClassCount', label: 'D类数量', color: '#dc3545' }
    ];

    // 构建数据集
    const datasets = [];
    customerTypeIndicators.forEach(indicator => {
        const values = data.map(d => d[indicator.key]);
        const avgValue = values.reduce((sum, val) => sum + val, 0) / values.length;

        // 主数据线
        datasets.push({
            label: indicator.label,
            data: values,
            borderColor: indicator.color,
            backgroundColor: indicator.color + '33',
            borderWidth: 2,
            fill: false,
            tension: 0.1
        });

        // 参考线
        datasets.push({
            label: indicator.label + '平均',
            data: Array(values.length).fill(avgValue),
            borderColor: indicator.color,
            borderWidth: 1,
            borderDash: [5, 5],
            fill: false,
            pointRadius: 0
        });
    });

    return new Chart(ctx, {
        type: 'line',
        data: {
            labels: monthlyLabels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false // 标准化：隐藏图例
                },
                title: {
                    display: true,
                    text: '老客分析',
                    font: {
                        size: 16,
                        weight: 'bold'
                    }
                },
                tooltip: {
                    filter: function(tooltipItem) {
                        return tooltipItem.datasetIndex < customerTypeIndicators.length; // 过滤参考线
                    },
                    callbacks: {
                        label: function(context) {
                            const indicator = customerTypeIndicators[context.datasetIndex % customerTypeIndicators.length];
                            return `${indicator.label}: ${formatValue(context.parsed.y)}`;
                        }
                    }
                },
                datalabels: {
                    display: function(context) {
                        return context.datasetIndex < customerTypeIndicators.length && context.dataIndex % 3 === 0;
                    },
                    color: '#666',
                    font: {
                        weight: 'bold',
                        size: 10
                    },
                    formatter: function(value) {
                        return formatValue(value);
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatValue(value);
                        }
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
}
```

#### 2.4 通用工具函数模块

##### 数值格式化函数
```javascript
function formatValue(value) {
    if (value === null || value === undefined || isNaN(value)) {
        return '0';
    }

    // 处理大数值显示
    if (value >= 10000) {
        return (value / 10000).toFixed(1) + '万';
    }

    // 处理小数精度
    if (value % 1 !== 0) {
        return value.toFixed(1);
    }

    return Math.round(value).toString();
}
```

##### 图表管理函数
```javascript
let charts = {}; // 存储所有图表实例

// 初始化所有图表
function initializeCharts() {
    // 基础指标图表
    charts.revenue = createBasicChart('revenueChart', '总营收', 'totalRevenue', '#667eea', '#667eea');
    charts.confirmedIncome = createBasicChart('confirmedIncomeChart', '确认收入', 'confirmedIncome', '#28a745', '#28a745');
    charts.totalCustomers = createBasicChart('totalCustomersChart', '总客流', 'totalCustomers', '#ffc107', '#ffc107');
    charts.oldCustomers = createBasicChart('oldCustomersChart', '老客', 'oldCustomers', '#dc3545', '#dc3545');
    // ... 其他基础指标

    // 组合分析图表
    charts.customerType = createCustomerTypeChart();
    charts.aClassCombined = createAClassCombinedChart();
}

// 切换门店时更新图表
function switchStore(storeName) {
    selectedStore = storeName;

    // 销毁现有图表
    Object.values(charts).forEach(chart => {
        if (chart) chart.destroy();
    });

    // 重新初始化图表
    initializeCharts();
}
```

### 3. 标准化配置规范

#### 3.1 图表统一配置
```javascript
const CHART_DEFAULTS = {
    responsive: true,
    maintainAspectRatio: false,
    interaction: {
        intersect: false,
        mode: 'index'
    },
    plugins: {
        legend: {
            display: false  // 所有图表统一隐藏图例
        },
        tooltip: {
            backgroundColor: 'rgba(0,0,0,0.8)',
            titleColor: '#fff',
            bodyColor: '#fff',
            borderColor: '#ddd',
            borderWidth: 1,
            cornerRadius: 4,
            displayColors: true,
            filter: function(tooltipItem) {
                // 通用过滤逻辑：隐藏参考线
                const dataset = tooltipItem.chart.data.datasets[tooltipItem.datasetIndex];
                return !dataset.label || !dataset.label.includes('平均');
            }
        },
        datalabels: {
            display: function(context) {
                // 通用显示逻辑：主数据线每3个点显示
                return context.datasetIndex % 2 === 0 && context.dataIndex % 3 === 0;
            },
            color: '#666',
            font: {
                weight: 'bold',
                size: 10
            },
            formatter: formatValue
        }
    },
    scales: {
        y: {
            beginAtZero: true,
            grid: {
                color: 'rgba(0,0,0,0.05)'
            },
            ticks: {
                callback: formatValue
            }
        },
        x: {
            grid: {
                display: false
            }
        }
    }
};
```

#### 3.2 颜色方案标准化
```javascript
const COLOR_SCHEMES = {
    primary: ['#667eea', '#28a745', '#ffc107', '#dc3545', '#17a2b8'],
    reference: '#ff6384',
    background: '#f8f9fa',
    text: '#495057'
};
```

### 4. 关键问题解决方案

#### 4.1 数据标签显示问题
**问题**: 组合图表中每月数据标签不显示
**解决方案**:
```javascript
datalabels: {
    display: function(context) {
        // 只对主数据集（非参考线）且每3个数据点显示标签
        const isMainDataset = context.datasetIndex < indicatorCount;
        const shouldShowLabel = context.dataIndex % 3 === 0;
        return isMainDataset && shouldShowLabel;
    }
}
```

#### 4.2 悬浮提示重复显示问题
**问题**: 悬浮时显示重复数据和小数点精度问题
**解决方案**:
```javascript
tooltip: {
    filter: function(tooltipItem) {
        // 过滤掉参考线数据集
        return tooltipItem.datasetIndex < mainDatasetCount;
    },
    callbacks: {
        label: function(context) {
            // 使用统一的数值格式化函数
            return `${context.dataset.label}: ${formatValue(context.parsed.y)}`;
        }
    }
}
```

#### 4.3 参考线集成方案
**问题**: 参考线需要在数据标签和悬浮提示中隐藏
**解决方案**:
1. 参考线使用 `borderDash: [5, 5]` 虚线样式
2. 参考线设置 `pointRadius: 0` 隐藏数据点
3. 在 `tooltip.filter` 中过滤参考线数据集
4. 在 `datalabels.display` 中排除参考线

### 5. 性能优化策略

#### 5.1 数据处理优化
```javascript
// 数据缓存机制
const dataCache = new Map();

function getCachedData(storeName, dataKey) {
    const cacheKey = `${storeName}_${dataKey}`;
    if (!dataCache.has(cacheKey)) {
        const data = storeData[storeName].map(d => d[dataKey]);
        dataCache.set(cacheKey, data);
    }
    return dataCache.get(cacheKey);
}
```

#### 5.2 图表渲染优化
```javascript
// 防抖处理
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// 图表更新防抖
const debouncedUpdateCharts = debounce(updateCharts, 300);
```

### 6. 开发规范与最佳实践

#### 6.1 编码规范
1. **命名规范**: 使用有意义的变量名和函数名
2. **注释规范**: 关键逻辑添加详细注释
3. **错误处理**: 完善的try-catch机制
4. **代码复用**: 提取公共函数和配置

#### 6.2 调试策略
1. **数据验证**: 添加数据完整性检查
2. **图表调试**: 使用Chart.js调试模式
3. **性能监控**: 监控图表渲染时间
4. **用户反馈**: 收集用户体验问题

#### 6.3 版本控制
1. **代码备份**: 定期备份修改
2. **变更记录**: 记录重要功能修改
3. **测试验证**: 修改后全面测试

### 7. 常见问题解决清单

#### 7.1 已解决问题
- ✅ 图表标题修正（客户类型分析→老客分析，新客来源分析→新客分析）
- ✅ 数据标签显示问题（每3个月显示一次）
- ✅ 悬浮提示重复和精度问题
- ✅ 图例统一显示/隐藏
- ✅ 参考线正确集成

#### 7.2 问题预防措施
- **标准化模板**: 所有新图表使用统一模板
- **代码审查**: 修改前检查现有实现
- **测试覆盖**: 修改后测试所有相关功能
- **文档更新**: 及时更新技术文档

## 技术栈
- **前端框架**: HTML5 + JavaScript (ES6+)
- **图表库**: Chart.js 3.9.1
- **数据处理**: 原生JavaScript CSV解析
- **样式设计**: CSS3 + 响应式布局
- **插件依赖**: chartjs-plugin-datalabels@2.0.0

---
**文档创建时间**: 2025年11月10日
**最后更新时间**: 2025年11月10日
**版本**: v2.0